<%- include('partials/header') %>

<h1>Mongo Query Builder</h1>

<div class="row g-3">
    <div class="col-6">
        <label class="form-label fw-bold" for="collection">Collection</label>
        <select id="collection" class="form-select">
        </select>
    </div>
    <div class="col-12">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query" type="button"
                    role="tab" aria-controls="query" aria-selected="true">Query</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="aggregation-tab" data-bs-toggle="tab" data-bs-target="#aggregation"
                    type="button" role="tab" aria-controls="aggregation" aria-selected="false">Aggregation</button>
            </li>
        </ul>
        <div class="tab-conten border border-top-0 p-3" id="myTabContent">
            <div class="tab-pane fade show active" id="query" role="tabpanel" aria-labelledby="query-tab">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="row g-3">
                            <div id="rules" class="col-12" hidden></div>
                            <div class="col-4">
                                <button type="button" class="btn btn-secondary" onclick="addRule()">
                                    + Aggiungi condizione
                                </button>
                            </div>
                            <input type="hidden" name="query" id="queryInput">
                            <div class="col-12">
                                <fieldset class="p-3" style="border: 1px solid darkgray">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="mongoOptionsSwitch">
                                                <label class="form-check-label fw-bold" for="mongoOptionsSwitch">Opzioni
                                                    Mongo</label>
                                            </div>
                                        </div>
                                        <div id="mongoOptionsFields" class="col-12" style="display: none;">
                                            <div class="row g-3">
                                                <div class="col-12">
                                                    <div class="">
                                                        <label class="form-label fw-semibold">Ordinamento</label>
                                                        <div class="row g-3">
                                                            <div class="col-6">
                                                                <select id="sortField" class="form-select">
                                                                    <option value="">-- Nessun ordinamento --</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-3">
                                                                <select id="sortOrder" class="form-select">
                                                                    <option value="1">Ascendente</option>
                                                                    <option value="-1">Discendente</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="">
                                                        <label class="form-label fw-semibold">Limit</label>
                                                        <input type="number" id="limit" class="form-control" min="1">
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="">
                                                        <label class="form-label fw-semibold">Proiezione</label>
                                                        <div id="projectionFields" class="row g-2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <input type="hidden" id="optionsInput">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 class="form-label fw-bold">Query Mongo editor</h5>
                        <div id="editor" style="height: 395px; border: 1px solid #ccc"></div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="aggregation" role="tabpanel" aria-labelledby="aggregation-tab" hidden>
                <div class="row g-3">
                    <div class="col-3">
                        <h5>Stages</h5>
                        <div id="stages" class="d-grid gap-2">
                            <button class="btn btn-primary stage-btn" data-stage="$match">$match</button>
                            <button class="btn btn-primary stage-btn" data-stage="$project">$project</button>
                            <button class="btn btn-primary stage-btn" data-stage="$group">$group</button>
                            <button class="btn btn-primary stage-btn" data-stage="$lookup">$lookup</button>
                            <button class="btn btn-primary stage-btn" data-stage="$unwind">$unwind</button>
                            <button class="btn btn-primary stage-btn" data-stage="$addFields">$addFields</button>
                            <button class="btn btn-primary stage-btn" data-stage="$facet">$facet</button>
                            <button class="btn btn-primary stage-btn" data-stage="$replaceRoot">$replaceRoot</button>
                            <button class="btn btn-primary stage-btn" data-stage="$bucket">$bucket</button>
                            <button class="btn btn-primary stage-btn" data-stage="$geoNear">$geoNear</button>
                            <button class="btn btn-primary stage-btn" data-stage="$count">$count</button>
                            <button class="btn btn-primary stage-btn" data-stage="$sort">$sort</button>
                            <button class="btn btn-primary stage-btn" data-stage="$limit">$limit</button>
                            <button class="btn btn-primary stage-btn" data-stage="$skip">$skip</button>
                            <button class="btn btn-primary stage-btn" data-stage="$out">$out</button>
                        </div>
                    </div>
                    <div class="col-9">
                        <h5 class="form-label fw-bold">Pipeline Mongo editor</h5>
                        <div id="editor-aggr" style="height: 395px; border: 1px solid #ccc"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12">
        <div class="row g-3">
            <div class="col-12">
                <fieldset class="p-3" style="border: 1px solid darkgray">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="includeData">
                                <label class="form-check-label fw-bold" for="includeData">Carica dati su S3</label>
                            </div>
                        </div>
                        <div id="data-prefix" class="col-7" hidden>
                            <label for="gridfsSuffix" class="form-label fw-semibold">Prefisso su Bucket S3</label>
                            <input type="text" id="data-prefix-val" class="form-control">
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="col-12">
        <fieldset class="p-3" style="border: 1px solid darkgray">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="gridfsSwitch">
                <label class="form-check-label fw-bold" for="gridfsSwitch">GridFS</label>
            </div>
            <div id="gridfsFields" class="mt-3" style="display: none;">
                <div class="row g-3">
                    <div id="gridfs-prefix" class="col-4">
                        <label for="gridfsSuffix" class="form-label fw-semibold">Prefisso su Bucket S3</label>
                        <input type="text" id="gridfs-prefix-val" class="form-control">
                    </div>
                    <div class="col-4">
                        <label class="form-label fw-bold" for="collection">GridFs Collection</label>
                        <select id="gridFsCollection" class="form-select">
                        </select>
                    </div>
                    <div class="col-4">
                        <label for="gridfsMatchField" class="form-label fw-semibold">Campo per il match della collection GridFS(*)</label>
                        <select id="gridfsMatchField" class="form-select">
                            <option value="_id">_id</option>
                            <option value="filename">filename</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label for="gridfsField" class="form-label fw-semibold">Campo collection per il match con GridFS(*)</label>
                        <label hidden for="gridfsFieldText" class="form-label fw-semibold">Campo collection per il match con GridFS(*)</label>
                        <select id="gridfsField" class="form-select">
                            <option value="">-- Seleziona un campo --</option>
                        </select>
                        <input hidden type="text" id="gridfsFieldText" class="form-control" placeholder="Inserire il nome di un campo dell'aggregazione"/>
                    </div>
                    <div class="col-4">
                        <label for="gridfsPrefix" class="form-label fw-semibold">Prefisso valore campo</label>
                        <input type="text" id="gridfsPrefix" class="form-control">
                    </div>
                    <div class="col-4">
                        <label for="gridfsSuffix" class="form-label fw-semibold">Suffisso valore campo</label>
                        <input type="text" id="gridfsSuffix" class="form-control">
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="col-auto">
        <button id="exec" type="button" class="btn btn-primary">Esegui</button>
    </div>
    <div class="col-auto">
        <a id="s3" href="/v2/resultsS3" class="btn btn-warning">AWS S3 Bucket</a>
    </div>
    <div hidden id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2">Caricamento in corso...</div>
    </div>
</div>

<script src="/js/query-builder2.js"></script>
<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script>
    require.config({
        paths: {
            vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs'
        }
    });

    require(['vs/editor/editor.main'], function () {
        window.initMonaco();
    });
</script>
<%- include('partials/footer') %>
