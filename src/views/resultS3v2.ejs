<%- include('partials/header') %>
<h1 class="mb-4">AWS S3 Bucket</h1>
<div class="row g-3">
    <div class="col-12">
        <fieldset class="fieldset-bordered h-100">
            <legend>Filtri</legend>
            <div class="row g-3">
                <div class="col-4">
                    <label for="prefixInput" class="form-label fw-semibold">Prefisso</label>
                    <input type="text" id="prefixInput" class="form-control" />
                </div>
                <div class="col-2">
                    <label for="limit" class="form-label fw-semibold">Limite</label>
                    <input type="number" id="limit" class="form-control" min="1" max="999999999" step="1" value="1000" />
                </div>
                <div class="col-1" style="align-content: end;">
                    <div class="form-check">
                        <label class="form-check-label fw-semibold">
                            <input type="checkbox" id="unlimit" class="form-check-input me-1" onchange="toggleUnlimit(event)">Tutti
                        </label>
                    </div>
                </div>
                <div class="col-auto ms-auto" style="align-content: end;">
                    <div class="btn-group" role="group" aria-label="Visualizzazione">
                        <button type="button" id="btnViewTable" class="btn btn-outline-primary active" title="Visualizzazione tabellare" onclick="switchView('table')">
                            <i class="bi bi-table"></i>
                        </button>
                        <button type="button" id="btnViewTree" class="btn btn-outline-primary" title="Visualizzazione ad albero" onclick="switchView('tree')">
                            <i class="bi bi-diagram-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="col-auto">
        <button id="searchBtn" class="btn btn-primary">
            Cerca
        </button>
    </div>
    <div class="col-auto">
        <button id="delBtn" class="btn btn-outline-danger" onclick="delMassive()" disabled>
            Elimina tutti
        </button>
    </div>
    <div class="col-auto">
        <a id="nq" href="/v2" class="btn btn-outline-primary">Nuova query</a>
    </div>
</div>

<div id="empty" class="alert alert-warning d-none mt-3">
    Nessun risultato trovato.
</div>

<div id="execSearch" class="alert alert-info mt-3">
    Esegui la ricerca
</div>

<div id="tableContainer" class="d-none">
    <div class="my-3">
        <strong>Totale risultati:</strong>
        <span id="total"></span>
    </div>

    <table class="table table-striped align-middle">
        <thead class="table-dark">
            <tr>
                <th onclick="sortResults('fileName')" style="cursor:pointer" class="user-select-none">
                    Filename <i id="sortIcon-fileName" class="bi bi-sort-alpha-down ms-1"></i>
                </th>
                <th onclick="sortResults('size')" style="cursor:pointer" class="user-select-none">
                    Size <i id="sortIcon-size" class="bi ms-1 d-none"></i>
                </th>
                <th onclick="sortResults('lastModified')" style="cursor:pointer" class="user-select-none">
                    Last edit <i id="sortIcon-lastModified" class="bi ms-1 d-none"></i>
                </th>
                <th style="width: 120px">Azioni</th>
            </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
    </table>
</div>

<script>
    let currentData = [];
    let sortDirection = 1;
    let currentSortKey = "fileName";
    let currentViewMode = 'table';

    const empty = document.getElementById("empty");
    const execSearch = document.getElementById("execSearch");
    const tableContainer = document.getElementById("tableContainer");
    const resultsBody = document.getElementById("resultsBody");
    const totalEl = document.getElementById("total");
    const prefixInput = document.getElementById("prefixInput");
    const limit = document.getElementById("limit");
    const unlimit = document.getElementById("unlimit");
    const searchBtn = document.getElementById("searchBtn");
    const delBtn = document.getElementById("delBtn");

    function switchView(mode) {
        currentViewMode = mode;

        document.getElementById('btnViewTable').classList.toggle('active', mode === 'table');
        document.getElementById('btnViewTree').classList.toggle('active', mode === 'tree');

        renderMain();
    }

    function renderMain() {
        if (currentData.length === 0) return;

        if (currentViewMode === 'tree') {
            renderTree(currentData);
        } else {
            renderTable(currentData);
        }
    }

    function toggleSpinner() {
        const spinner = document.getElementById("loadingOverlay");
        if (spinner?.classList.contains("d-none")) {
            spinner?.classList.remove("d-none");
        } else {
            spinner?.classList.add("d-none");
        }
    }

    function formatSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
        let size = bytes;
        let unitIndex = 0;

        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }

        return `${size.toFixed(2)} ${units[unitIndex]}`;
    }

    function toggleUnlimit(e) {
        e.target.checked
        ? limit.setAttribute("disabled", true)
        : limit.removeAttribute("disabled");
    }

    function sortResults(key, isFirstLoad = false) {
        if(currentViewMode === "tree") {
            return;
        } else if (!isFirstLoad && currentSortKey === key) {
            sortDirection *= -1;
        } else if (!isFirstLoad) {
            sortDirection = 1;
            currentSortKey = key;
        }

        document.querySelectorAll('th i.bi').forEach(icon => {
            icon.classList.add('d-none');
            icon.className = 'bi ms-1 d-none';
        });

        const activeIcon = document.getElementById(`sortIcon-${key}`);
        activeIcon.classList.remove('d-none');

        if (key === 'fileName') {
            activeIcon.classList.add(sortDirection === 1 ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up');
        } else if (key === 'size') {
            activeIcon.classList.add(sortDirection === 1 ? 'bi-sort-numeric-down' : 'bi-sort-numeric-up');
        } else {
            activeIcon.classList.add(sortDirection === 1 ? 'bi-sort-down' : 'bi-sort-up');
        }

        currentData.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (key === 'lastModified') {
                valA = valA ? new Date(valA).getTime() : 0;
                valB = valB ? new Date(valB).getTime() : 0;
            }

            if (typeof valA === 'string') {
                return valA.localeCompare(valB) * sortDirection;
            }

            return (valA - valB) * sortDirection;
        });

        renderTable(currentData);
    }

    function renderTable(data) {
        resultsBody.innerHTML = "";
        totalEl.textContent = data.length;

        data.forEach((item, index) => {
            const tr = document.createElement("tr");
            tr.setAttribute("id", "row-" + index);
            tr.innerHTML = `
            <td>${item.fileName}</td>
            <td>${formatSize(item.size)}</td>
            <td>${!!item.lastModified ? new Date(item.lastModified).toLocaleString() : "N.D."}</td>
            <td>
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-primary" onclick="downloadFile(event, ${index},'${item.fileName}')">Scarica</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteFile(event, ${index},'${item.fileName}')">Elimina</button>
                </div>
            </td>
        `;
            resultsBody.appendChild(tr);
        });
    }

    async function loadResults(prefix = "", limit, unlimit) {
        toggleSpinner();
        execSearch.classList.add("d-none");
        empty.classList.add("d-none");
        tableContainer.classList.add("d-none");
        resultsBody.innerHTML = "";

        try {
            const encodedPrefix = encodeURIComponent(prefix);
            const res = await fetch(`/api/v2/s3/${encodedPrefix || "-1"}/${unlimit ? "-1" : limit}`);
            const data = await res.json();

            if (!data || data.length === 0) {
                empty.classList.remove("d-none");
                return;
            }

            currentData = data;
            sortResults('fileName', true);

            tableContainer.classList.remove("d-none");
            delBtn.removeAttribute("disabled");
            renderTable(currentData)
        } catch (err) {
            delBtn.setAttribute("disabled", true);
            execSearch.classList.remove("d-none");
            empty.classList.add("d-none");
            alert("Errore nel caricamento dei dati");
            console.error(err);
        } finally {
            toggleSpinner();
        }
    }

    searchBtn.addEventListener("click", () => {
        loadResults(encodeURIComponent(prefixInput.value.trim()), limit.value, unlimit.checked);
    });

    prefixInput.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            loadResults(encodeURIComponent(prefixInput.value.trim()), limit.value, unlimit.checked);
        }
    });

    limit.addEventListener("keydown", e => {
        if (e.key === "Enter") {
            loadResults(encodeURIComponent(prefixInput.value.trim()), limit.value, unlimit.checked);
        }
    });

    async function delMassive() {
        if(!prefixInput.value) {
            alert("Impossibile eliminare senza inserire un prefisso.");
            return;
        } else {
            if(!confirm(`Sei sicuro di voler eliminare i file con il prefisso ${prefixInput.value}?`)) {
                return;
            }
            toggleSpinner();
            try {
                const res = await fetch(`/api/v2/s3-del-many/${encodeURIComponent(prefixInput.value.trim())}`);
                if(!res.ok) {
                    throw Error((await res.json()).message);
                }
                const data = await res.json();
                if(data.errors.length > 0) {
                    alert(["Non Ã¨ stato possibile eliminare i file seguenti:", ...data.errors].join("\n"));
                }
                delBtn.setAttribute("disabled", true);
                toggleSpinner();
                await loadResults(prefixInput.value.trim(), limit.value, unlimit.checked);
            } catch (error) {
                toggleSpinner();
                alert(error.message);
            }
        }
    }

    async function deleteFile(index, id) {
        if (!confirm(`Sei sicuro di voler eliminare il file ${id}?`)) {
            return;
        }

        const btn = document.querySelector(`#row-${index} button:nth-child(2)`);
        btn.disabled = true;
        btn.textContent = "Elimino...";

        try {
            const res = await fetch(`/api/v2/s3-del-one/${encodeURIComponent(id)}`);

            if (!res.ok) {
                throw new Error("Errore eliminazione");
            }

            document.getElementById(`row-${index}`).remove();

            const totalEl = document.getElementById("total");
            totalEl.textContent = Number(totalEl.textContent) - 1;

            if (Number(totalEl.textContent) === 0) {
                document.getElementById("tableContainer").classList.add("d-none");
                document.getElementById("empty").classList.remove("d-none");
            }

        } catch (err) {
            alert("Errore durante l'eliminazione");
            btn.disabled = false;
            btn.textContent = "Elimina";
            console.error(err);
        }
    }

    async function downloadFile(event, index, id) {
        const btn = event.target;
        try {
            btn.disabled = true;
            btn.textContent = "Scarico...";
            const response = await fetch("/api/v2/s3-download-from-aws/"+ encodeURIComponent(id));
            if(!response.ok) {
                throw Error(response.statusText);
            }
            btn.disabled = false;
            btn.textContent = "Scarica";
            const { downloadUrl } = await response.json();
            window.location.href = downloadUrl;
        } catch (error) {
            alert("Errore durante il download");
            btn.disabled = false;
            btn.textContent = "Scarica";
            console.error(err);
        }
    }

    function buildTree(files) {
        const tree = {};
        files.forEach((file, index) => {
            const parts = file.fileName.split('/');
            let currentLevel = tree;

            parts.forEach((part, i) => {
                if (i === parts.length - 1) {
                    currentLevel[part] = { _isFile: true, data: file, originalIndex: index };
                } else {
                    if (!currentLevel[part]) currentLevel[part] = {};
                    currentLevel = currentLevel[part];
                }
            });
        });
        return tree;
    }
    function renderTree(data) {
        resultsBody.innerHTML = "";
        totalEl.textContent = data.length;
        const tree = buildTree(data);

        function renderNode(node, name, depth = 0, parentPath = "") {
            const safeParentPath = parentPath.replace(/[/ .]/g, '-');
            const currentPath = parentPath + name + "/";
            const safeCurrentPath = currentPath.replace(/[/ .]/g, '-');

            if (node._isFile) {
                const item = node.data;
                const tr = document.createElement("tr");
                tr.className = `file-row ${depth > 0 ? 'd-none' : ''} child-of-${safeParentPath}`;
                tr.innerHTML = `
                <td style="padding-left: ${(depth * 20)+5}px"><i class="bi bi-file-earmark me-2"></i>${name}</td>
                <td>${formatSize(item.size)}</td>
                <td>${item.lastModified ? new Date(item.lastModified).toLocaleString() : "N.D."}</td>
                <td>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-primary" onclick="downloadFile(event, ${node.originalIndex},'${item.fileName}')">Scarica</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteFile(event, ${node.originalIndex},'${item.fileName}')">Elimina</button>
                    </div>
                </td>`;
                resultsBody.appendChild(tr);
            } else {
                const tr = document.createElement("tr");
                tr.className = `table-secondary folder-row ${depth > 0 ? 'd-none' : ''} child-of-${safeParentPath}`;
                tr.style.cursor = "pointer";

                tr.innerHTML = `
                <td colspan="4" style="padding-left: ${(depth * 20)+5}px" onclick="toggleFolder(this, '${safeCurrentPath}')">
                    <i class="bi bi-chevron-right me-2 toggle-icon"></i>
                    <i class="bi bi-folder-fill me-2 text-warning"></i><strong>${name}</strong>
                </td>`;
                resultsBody.appendChild(tr);

                Object.keys(node).sort().forEach(childName => {
                    renderNode(node[childName], childName, depth + 1, currentPath);
                });
            }
        }

        Object.keys(tree).sort().forEach(key => renderNode(tree[key], key));
    }


    function toggleFolder(element, path) {
        const children = document.querySelectorAll(`.child-of-${path}`);
        const icon = element.querySelector('.toggle-icon');

        const isOpening = children.length > 0 && children[0].classList.contains('d-none');

        if (isOpening) {
            children.forEach(child => child.classList.remove('d-none'));
            icon.classList.replace('bi-chevron-right', 'bi-chevron-down');
        } else {
            closeRecursive(path);
            icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
        }
    }

    function closeRecursive(path) {
        const children = document.querySelectorAll(`.child-of-${path}`);
        children.forEach(child => {
            child.classList.add('d-none');
            if (child.classList.contains('folder-row')) {
                const folderName = child.innerText.trim();
                const icon = child.querySelector('.toggle-icon');
                if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
            }
        });

        document.querySelectorAll(`[class*="child-of-${path}"]`).forEach(el => {
            el.classList.add('d-none');
            const icon = el.querySelector('.toggle-icon');
            if (icon) icon.classList.replace('bi-chevron-down', 'bi-chevron-right');
        });
    }
</script>

<%- include('partials/footer') %>
